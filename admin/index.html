---
layout: default
title: Admin
---

<main style="max-width:900px;margin:30px auto;">
  <h2 id="heading">Admin Login</h2>

  <!-- LOGIN -->
  <div id="loginBox">
    <input id="user" placeholder="Username"><br><br>
    <input id="pass" type="password" placeholder="Password" type="password"><br><br>
    <button onclick="login()">Login</button>
    <p id="loginMsg"></p>
  </div>

  <!-- EDITOR -->
  <div id="editor" style="display:none;">
    <h3>Post Editor</h3>

    <label>Title</label>
    <input id="title" style="width:100%;"><br><br>

    <label>Date</label>
    <input id="date" type="date"><br><br>

    <label>Category</label>
    <input id="category"><br><br>

    <label>Authors</label>
    <div id="authors"></div>
    <button type="button" onclick="addAuthor()">Add Author</button><br><br>

    <label>Excerpt</label>
    <textarea id="excerpt" rows="2" style="width:100%;"></textarea><br><br>

    <label>Featured Image Path</label>
    <input id="image" placeholder="assets/images/posts/postname/image.jpg"><br><br>

    <label>Featured Image Alt</label>
    <input id="imageAlt"><br><br>

    <label>Markdown Content</label>
    <textarea id="content" rows="15" style="width:100%;"></textarea><br><br>

    <label>
      <input type="checkbox" id="update"> Update existing post
    </label><br><br>

    <label>
      <input type="checkbox" id="showPreview" onchange="togglePreview()"> Show Preview
    </label><br><br>

    <div id="preview" class="hidden" style="border:1px solid #ccc;padding:10px;margin:10px 0;white-space:pre-wrap;"></div>

    <button onclick="publish()">Publish / Update</button>

    <div style="margin-top:20px;">
      <progress id="progress" value="0" max="100" style="width:100%;"></progress>
      <p id="status"></p>
    </div>
  </div>
</main>

<script>
/* ==== LOGIN ==== */
function login() {
  const user = document.getElementById("user").value;
  const pass = document.getElementById("pass").value;

  fetch("/.netlify/functions/auth", {  // Correct function endpoint
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ user, pass })
  })
    .then(r => r.json())
    .then(d => {
      if (d.ok) {
        document.getElementById("loginBox").style.display = "none";
        document.getElementById("editor").style.display = "block";
        document.getElementById("heading").innerText = "Admin Panel";
      } else {
        document.getElementById("loginMsg").innerText = "Invalid credentials";
      }
    })
    .catch(err => {
      document.getElementById("loginMsg").innerText = "Login error";
      console.error(err);
    });
}

/* ==== HELPERS ==== */
function slugify(text) {
  return text
    .toLowerCase()
    .replace(/[^a-z0-9]+/g, "-")
    .replace(/(^-|-$)/g, "");
}

/* ==== PUBLISH ==== */
function publish() {
  const title = document.getElementById("title").value;
  const date = document.getElementById("date").value;
  const category = document.getElementById("category").value;
  const excerpt = document.getElementById("excerpt").value;
  const image = document.getElementById("image").value;
  const imageAlt = document.getElementById("imageAlt").value;
  const content = document.getElementById("content").value;

  const slug = slugify(title);
  const filename = ${date}-${slug}.md;

  document.getElementById("progress").value = 40;
  document.getElementById("status").innerText = "Publishing…";

  fetch("/.netlify/functions/github-post", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      filename,
      content
    })
  })
    .then(r => r.json())
    .then(d => {
      document.getElementById("progress").value = 100;
      document.getElementById("status").innerText =
        d.ok ? "✅ Published successfully" : "❌ Publish failed";
    })
    .catch(err => {
      document.getElementById("status").innerText = "❌ Network error";
      console.error(err);
    });
}

/* ==== PREVIEW TOGGLE ==== */
function togglePreview() {
  const preview = document.getElementById("preview");
  const show = document.getElementById("showPreview").checked;
  if (show) {
    preview.style.display = "block";
    preview.innerText = document.getElementById("content").value;
  } else {
    preview.style.display = "none";
  }
}
</script>
<style>
.hidden { display:none; }
.author-row { margin-bottom:5px; }
.author-row input { margin-right:5px; }
</style>

---
layout: default
title: Admin
---

<main style="max-width:900px;margin:30px auto;">
  <h2 id="heading">Admin Login</h2>

  <!-- LOGIN -->
  <div id="loginBox">
    <input id="user" placeholder="Username"><br><br>
    <input id="pass" type="password" placeholder="Password"><br><br>
    <button id="loginBtn">Login</button>
    <p id="loginMsg"></p>
  </div>

  <!-- EDITOR -->
  <div id="editor" style="display:none;">
    <h3>Post Editor</h3>

    <label>Title</label>
    <input id="title" style="width:100%;"><br><br>

    <label>Date</label>
    <input id="date" type="date"><br><br>

    <label>Category</label>
    <input id="category"><br><br>

    <label>Authors</label>
    <div id="authors"></div>
    <button type="button" onclick="addAuthor()">Add Author</button><br><br>

    <label>Excerpt</label>
    <textarea id="excerpt" rows="2" style="width:100%;"></textarea><br><br>

    <label>Featured Image Path</label>
    <input id="image" placeholder="assets/images/posts/postname/image.jpg"><br><br>

    <label>Featured Image Alt</label>
    <input id="imageAlt"><br><br>

    <label>Markdown Content</label>
    <textarea id="content" rows="15" style="width:100%;"></textarea><br><br>

    <label>
      <input type="checkbox" id="update"> Update existing post
    </label><br><br>

    <label>
      <input type="checkbox" id="showPreview"> Show Preview
    </label><br><br>

    <div id="preview" class="hidden" style="border:1px solid #ccc;padding:10px;margin:10px 0;white-space:pre-wrap;"></div>

    <button onclick="publish()">Publish / Update</button>

    <div style="margin-top:20px;">
      <progress id="progress" value="0" max="100" style="width:100%;"></progress>
      <p id="status"></p>
    </div>
  </div>
</main>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const loginBtn = document.getElementById("loginBtn");
  const showPreviewCheckbox = document.getElementById("showPreview");
  const contentInput = document.getElementById("content");

  // ==== LOGIN ====
  loginBtn.addEventListener("click", login);

  function login() {
    const user = document.getElementById("user").value.trim();
    const pass = document.getElementById("pass").value.trim();

    if (!user || !pass) {
      document.getElementById("loginMsg").innerText = "Enter username and password";
      return;
    }

    console.log("Login attempt:", user);

    fetch("/.netlify/functions/auth", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ user, pass })
    })
      .then(r => r.json())
      .then(d => {
        if (d.ok) {
          document.getElementById("loginBox").style.display = "none";
          document.getElementById("editor").style.display = "block";
          document.getElementById("heading").innerText = "Admin Panel";
          addAuthor(); // add initial author row
        } else {
          document.getElementById("loginMsg").innerText = "Invalid credentials";
        }
      })
      .catch(err => {
        document.getElementById("loginMsg").innerText = "Login error";
        console.error(err);
      });
  }

  // ==== HELPERS ====
  function slugify(text) {
    return text.toLowerCase().replace(/[^a-z0-9]+/g, "-").replace(/(^-|-$)/g, "");
  }

  // ==== AUTHORS DYNAMIC FIELDS ====
  window.addAuthor = function(name = "", link = "") {
    const authorsDiv = document.getElementById("authors");
    const row = document.createElement("div");
    row.className = "author-row";

    const nameInput = document.createElement("input");
    nameInput.type = "text";
    nameInput.placeholder = "Author Name";
    nameInput.className = "author-name";
    nameInput.value = name;

    const linkInput = document.createElement("input");
    linkInput.type = "text";
    linkInput.placeholder = "LinkedIn URL";
    linkInput.className = "author-link";
    linkInput.value = link;

    const removeBtn = document.createElement("button");
    removeBtn.type = "button";
    removeBtn.innerText = "Remove";
    removeBtn.addEventListener("click", () => row.remove());

    row.appendChild(nameInput);
    row.appendChild(linkInput);
    row.appendChild(removeBtn);
    authorsDiv.appendChild(row);
  };

  // ==== PREVIEW ====
  function updatePreview() {
    const preview = document.getElementById("preview");
    if (showPreviewCheckbox.checked) {
      preview.style.display = "block";
      preview.innerText = contentInput.value;
    } else {
      preview.style.display = "none";
    }
  }

  contentInput.addEventListener("input", updatePreview);
  showPreviewCheckbox.addEventListener("change", updatePreview);

  window.togglePreview = updatePreview;

  // ==== PUBLISH ====
  window.publish = function() {
    const title = document.getElementById("title").value.trim();
    const date = document.getElementById("date").value;
    const category = document.getElementById("category").value.trim();
    const excerpt = document.getElementById("excerpt").value.trim();
    const image = document.getElementById("image").value.trim();
    const imageAlt = document.getElementById("imageAlt").value.trim();
    const content = contentInput.value;

    if (!title || !date || !content) {
      alert("Title, date, and content are required");
      return;
    }

    const authors = Array.from(document.querySelectorAll(".author-row")).map(row => ({
      name: row.querySelector(".author-name").value.trim(),
      link: row.querySelector(".author-link").value.trim()
    }));

    const slug = slugify(title);
    const filename = `${date}-${slug}.md`;

    const frontMatter = `---
layout: post
title: "${title}"
date: ${date}
category: ${category}
authors: ${JSON.stringify(authors)}
excerpt: "${excerpt}"
featured_image: "${image}"
featured_image_alt: "${imageAlt}"
---
${content}`;

    const progress = document.getElementById("progress");
    const status = document.getElementById("status");
    progress.value = 40;
    status.innerText = "Publishing…";

    fetch("/.netlify/functions/github-post", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ filename, content: frontMatter })
    })
      .then(r => r.json())
      .then(d => {
        progress.value = 100;
        status.innerText = d.ok ? "✅ Published successfully" : "❌ Publish failed";
        setTimeout(() => {
          progress.value = 0;
          status.innerText = "";
        }, 4000);
      })
      .catch(err => {
        status.innerText = "❌ Network error";
        console.error(err);
      });
  };
});
</script>

<style>
.hidden { display:none; }
.author-row { margin-bottom:5px; }
.author-row input { margin-right:5px; }
</style>

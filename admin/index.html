---layout: default
title: Admin
---

<main style="max-width:900px;margin:30px auto;">
  <h2 id="heading">Admin Login</h2>

  <!-- LOGIN -->
  <div id="loginBox">
    <input id="user" placeholder="Username"><br><br>
    <input id="pass" type="password" placeholder="Password" type="password"><br><br>
    <button onclick="login()">Login</button>
    <p id="loginMsg"></p>
  </div>

  <!-- EDITOR -->
  <div id="editor" style="display:none;">
    <h3>Post Editor</h3>

    <label>Title</label>
    <input id="title" style="width:100%;"><br><br>

    <label>Date</label>
    <input id="date" type="date"><br><br>

    <label>Category</label>
    <input id="category"><br><br>

    <label>Authors</label>
    <div id="authors"></div>
    <button type="button" onclick="addAuthor()">Add Author</button><br><br>

    <label>Excerpt</label>
    <textarea id="excerpt" rows="2" style="width:100%;"></textarea><br><br>

    <label>Featured Image Path</label>
    <input id="image" placeholder="assets/images/posts/postname/image.jpg"><br><br>

    <label>Featured Image Alt</label>
    <input id="imageAlt"><br><br>

    <label>Markdown Content</label>
    <textarea id="content" rows="15" style="width:100%;"></textarea><br><br>

    <label>
      <input type="checkbox" id="update"> Update existing post
    </label><br><br>

    <label>
      <input type="checkbox" id="showPreview" onchange="togglePreview()"> Show Preview
    </label><br><br>

    <div id="preview" class="hidden" style="border:1px solid #ccc;padding:10px;margin:10px 0;white-space:pre-wrap;"></div>

    <button onclick="publish()">Publish / Update</button>

    <div style="margin-top:20px;">
      <progress id="progress" value="0" max="100" style="width:100%;"></progress>
      <p id="status"></p>
    </div>
  </div>
</main>

<script>
const ADMIN = { username: 'hidden', password: 'hidden' }; // ignored, function uses env

function login() {
  fetch('/.netlify/functions/github-post', {
    method: 'POST',
    body: JSON.stringify({ action: 'login', user: user.value, pass: pass.value })
  })
  .then(r => r.json())
  .then(d => {
    if (d.ok) {
      loginBox.style.display = 'none';
      editor.style.display = 'block';
      heading.innerText = 'Admin Panel';
      addAuthor(); // add initial author field
    } else {
      loginMsg.innerText = 'Invalid credentials';
    }
  });
}

function addAuthor(name='', link='') {
  const div = document.createElement("div");
  div.className = "author-row";
  div.innerHTML = 
    <input placeholder="Author name" value="${name}">
    <input placeholder="Author link" value="${link}">
    <button type="button" onclick="this.parentNode.remove()">Remove</button>
  ;
  document.getElementById("authors").appendChild(div);
}

function slugify(text) {
  return text.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-|-$/g, '');
}

function togglePreview() {
  const preview = document.getElementById("preview");
  if (document.getElementById("showPreview").checked) {
    preview.classList.remove("hidden");
    preview.innerText = content.value;
  } else {
    preview.classList.add("hidden");
  }
}

async function publish() {
  const authors = Array.from(document.querySelectorAll(".author-row"))
    .map(row => {
      const inputs = row.querySelectorAll("input");
      return { name: inputs[0].value, link: inputs[1].value };
    })
    .filter(a => a.name);

  const slug = slugify(title.value);
  const dateStr = date.value;
  const filename = ${dateStr}-${slug}.md;

  const frontMatter = ---
layout: post
title: "${title.value}"
date: ${dateStr}
category: ${category.value}
authors: ${JSON.stringify(authors)}
excerpt: "${excerpt.value}"
featured_image: "${image.value}"
featured_image_alt: "${imageAlt.value}"
---
${content.value};

  progress.value = 20;
  status.innerText = 'Preparing post...';

  const res = await fetch('/.netlify/functions/github-post', {
    method: 'POST',
    body: JSON.stringify({
      action: 'publish',
      filename,
      content: frontMatter,
      update: document.getElementById("update").checked
    })
  });

const data = await res.json();
  progress.value = 100;
  status.innerText = data.ok ? '✅ Published successfully' : ❌ ${data.error || 'Error publishing'};
}
</script>
<style>
.hidden { display:none; }
.author-row { margin-bottom:5px; }
.author-row input { margin-right:5px; }
</style>

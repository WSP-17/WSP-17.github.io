---
layout: default
title: Admin
---

<main style="max-width:900px;margin:30px auto;">
  <h2 id="heading">Admin Login</h2>

  <!-- LOGIN -->
  <div id="loginBox">
    <input id="user" placeholder="Username"><br><br>
    <input id="pass" type="password" placeholder="Password"><br><br>
    <button onclick="login()">Login</button>
    <p id="loginMsg" style="color:red;"></p>
  </div>

  <!-- EDITOR -->
  <div id="editor" style="display:none;">
    <h3>Post Editor</h3>

    <label>Title</label>
    <input id="title" style="width:100%;"><br><br>

    <label>Date</label>
    <input id="date" type="date"><br><br>

    <label>Category</label>
    <input id="category"><br><br>

    <label>Authors</label>
    <div id="authors"></div>
    <button type="button" onclick="addAuthor()">Add Author</button><br><br>

    <label>Excerpt</label>
    <textarea id="excerpt" rows="2" style="width:100%;"></textarea><br><br>

    <label>Featured Image Path</label>
    <input id="image" placeholder="assets/images/posts/postname/image.jpg"><br><br>

    <label>Featured Image Alt</label>
    <input id="imageAlt"><br><br>

    <label>Markdown Content</label>
    <textarea id="content" rows="15" style="width:100%;"></textarea><br><br>

    <label>
      <input type="checkbox" id="update"> Update existing post
    </label><br><br>

    <label>
      <input type="checkbox" id="showPreview"> Show Preview
    </label><br><br>

    <div id="preview" class="hidden" style="border:1px solid #ccc;padding:10px;margin:10px 0;white-space:pre-wrap;"></div>

    <button onclick="publish()">Publish / Update</button>

    <div style="margin-top:20px;">
      <progress id="progress" value="0" max="100" style="width:100%;"></progress>
      <p id="status"></p>
    </div>
  </div>
</main>

<script>
/* ==== LOGIN ==== */
function login() {
  const user = document.getElementById("user").value.trim();
  const pass = document.getElementById("pass").value.trim();

  if (!user || !pass) {
    document.getElementById("loginMsg").innerText = "Enter username and password";
    return;
  }

  fetch("/.netlify/functions/auth", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ user, pass })
  })
    .then(r => r.json())
    .then(d => {
      if (d.ok) {
        document.getElementById("loginBox").style.display = "none";
        document.getElementById("editor").style.display = "block";
        document.getElementById("heading").innerText = "Admin Panel";
        addAuthor(); // add initial author row
      } else {
        document.getElementById("loginMsg").innerText = "Invalid credentials";
      }
    })
    .catch(err => {
      document.getElementById("loginMsg").innerText = "Login error";
      console.error(err);
    });
}

/* ==== HELPERS ==== */
function slugify(text) {
  return text.toLowerCase().replace(/[^a-z0-9]+/g, "-").replace(/(^-|-$)/g, "");
}

/* ==== AUTHORS DYNAMIC FIELDS ==== */
function addAuthor(name="", link="") {
  const authorsDiv = document.getElementById("authors");
  const row = document.createElement("div");
  row.className = "author-row";

  row.innerHTML = 
    <input type="text" placeholder="Author Name" class="author-name" value="${name}">
    <input type="text" placeholder="LinkedIn URL" class="author-link" value="${link}">
    <button type="button" onclick="this.parentElement.remove()">Remove</button>
  ;

  authorsDiv.appendChild(row);
}

/* ==== PREVIEW ==== */
document.getElementById("content").addEventListener("input", () => {
  if (document.getElementById("showPreview").checked) {
    document.getElementById("preview").innerText = document.getElementById("content").value;
  }
});

document.getElementById("showPreview").addEventListener("change", togglePreview);

function togglePreview() {
  const preview = document.getElementById("preview");
  const show = document.getElementById("showPreview").checked;
  if (show) {
    preview.style.display = "block";
    preview.innerText = document.getElementById("content").value;
  } else {
    preview.style.display = "none";
  }
}
/* ==== PUBLISH ==== */
function publish() {
  const title = document.getElementById("title").value.trim();
  const date = document.getElementById("date").value;
  const category = document.getElementById("category").value.trim();
  const excerpt = document.getElementById("excerpt").value.trim();
  const image = document.getElementById("image").value.trim();
  const imageAlt = document.getElementById("imageAlt").value.trim();
  const content = document.getElementById("content").value;

  if (!title  !date  !content) {
    alert("Title, date, and content are required");
    return;
  }

  const authors = Array.from(document.querySelectorAll(".author-row")).map(row => ({
    name: row.querySelector(".author-name").value.trim(),
    link: row.querySelector(".author-link").value.trim()
  }));

  const slug = slugify(title);
  const filename = ${date}-${slug}.md;

  const frontMatter = ---
layout: post
title: "${title}"
date: ${date}
category: ${category}
authors: ${JSON.stringify(authors)}
excerpt: "${excerpt}"
featured_image: "${image}"
featured_image_alt: "${imageAlt}"
---
${content};

  const progress = document.getElementById("progress");
  const status = document.getElementById("status");

  progress.value = 40;
  status.innerText = "Publishing…";

  fetch("/.netlify/functions/github-post", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ filename, content: frontMatter })
  })
    .then(r => r.json())
    .then(d => {
      progress.value = 100;
      status.innerText = d.ok ? "✅ Published successfully" : "❌ Publish failed";
      setTimeout(() => { progress.value = 0; status.innerText = ""; }, 4000);
    })
    .catch(err => {
      status.innerText = "❌ Network error";
      console.error(err);
    });
}
</script>

<style>
.hidden { display:none; }
.author-row { margin-bottom:5px; }
.author-row input { margin-right:5px; }
</style>
